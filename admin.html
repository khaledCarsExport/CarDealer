<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Khaled Cars</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <a href="index.html" class="logo">
                <i class="fas fa-car"></i>
                <span>Khaled Cars</span>
            </a>
           <div class="nav-links">
    <a href="index.html">Home</a>
    <a href="inventory.html">Inventory</a>
    <!-- "Sell Your Car" and "Admin" links removed -->
    <a href="tel:+1234567890" class="btn-call">
        <i class="fas fa-phone"></i> Call Now
    </a>
</div>
    </nav>

    <!-- Admin Dashboard -->
    <section class="admin-dashboard">
        <div class="container">
            <div class="admin-header">
                <h1><i class="fas fa-tachometer-alt"></i> Admin Dashboard</h1>
                <div class="admin-actions">
                    <button class="btn-refresh" onclick="loadDashboard()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <button class="btn-logout" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>
            
            <div class="dashboard-grid">
                <!-- Stats Cards -->
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-car"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="totalCars">0</h3>
                        <p>Total Cars</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-eye"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="activeListings">0</h3>
                        <p>Active Listings</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-image"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="totalImages">0</h3>
                        <p>Total Images</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="totalValue">0 M</h3>
                        <p>Total Inventory Value</p>
                    </div>
                </div>
            </div>
            
            <!-- Car Management -->
            <div class="admin-section">
                <div class="section-header">
                    <h2><i class="fas fa-list"></i> Car Management</h2>
                    <button class="btn-add" onclick="showAddForm()">
                        <i class="fas fa-plus"></i> Add New Car
                    </button>
                </div>
                
                <!-- Add/Edit Form (Hidden by default) -->
                <div class="admin-form" id="adminForm" style="display: none;">
                    <h3 id="formTitle">Add New Car</h3>
                    <form id="adminCarForm">
                        <input type="hidden" id="carId">
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="adminBrand">Brand *</label>
                                <input type="text" id="adminBrand" required>
                            </div>
                            <div class="form-group">
                                <label for="adminModel">Model *</label>
                                <input type="text" id="adminModel" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="adminYear">Year *</label>
                                <input type="number" id="adminYear" required>
                            </div>
                            <div class="form-group">
                                <label for="adminPrice">Price (M) *</label>
                                <input type="number" id="adminPrice" step="0.01" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="adminKilometrage">Kilometrage *</label>
                                <input type="number" id="adminKilometrage" required>
                            </div>
                            <div class="form-group">
                                <label for="adminBoite">Transmission *</label>
                                <select id="adminBoite" required>
                                    <option value="">Select</option>
                                    <option value="Automatic">Automatic</option>
                                    <option value="Manual">Manual</option>
                                    <option value="CVT">CVT</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="adminVersion">Version *</label>
                            <input type="text" id="adminVersion" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="adminDescription">Description</label>
                            <textarea id="adminDescription" rows="3"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>Upload Media</label>
                            <div class="file-upload-admin" onclick="document.getElementById('adminMediaInput').click()">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <p>Click to upload images & videos</p>
                                <input type="file" id="adminMediaInput" multiple accept="image/*,video/*" onchange="handleAdminMediaUpload(event)">
                            </div>
                            <div class="admin-media-preview" id="adminMediaPreview"></div>
                        </div>
                        
                        <div class="form-actions">
                            <button type="submit" class="btn-save" id="adminSubmitBtn">
                                <i class="fas fa-save"></i> Save Car
                            </button>
                            <button type="button" class="btn-cancel" onclick="hideAdminForm()">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- Cars Table -->
                <div class="admin-table-container">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Image</th>
                                <th>Car Details</th>
                                <th>Price</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="adminCarsTable">
                            <!-- Cars will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-grid">
                <div class="footer-col">
                    <a href="index.html" class="logo">
                        <i class="fas fa-car"></i>
                        <span>Khaled Cars</span>
                    </a>
                    <p>Premium car dealership offering the best selection of luxury and family vehicles.</p>
                    <div class="social-links">
                        <a href="#"><i class="fab fa-facebook"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                        <a href="#"><i class="fab fa-twitter"></i></a>
                        <a href="#"><i class="fab fa-whatsapp"></i></a>
                    </div>
                </div>
                <div class="footer-col">
                    <h3>Quick Links</h3>
                    <a href="index.html">Home</a>
                    <a href="inventory.html">Inventory</a>
                    <a href="add-car.html">Sell Your Car</a>
                    <a href="admin.html">Admin Login</a>
                </div>
                <div class="footer-col">
                    <h3>Contact Info</h3>
                    <p><i class="fas fa-map-marker-alt"></i> Ramdan Djamel ,Skikda</p>
                    <p><i class="fas fa-phone"></i> (213) 549883720</p>
                    <p><i class="fas fa-envelope"></i> khaledcarsexport.skikda@gmail.com</p>
                    <p><i class="fas fa-clock"></i> Mon-Sat: 9AM-7PM</p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 Khaled Cars. All rights reserved. | Admin Dashboard</p>
            </div>
        </div>
    </footer>

    <!-- Modal Gallery -->
    <div class="modal" id="galleryModal">
        <button class="modal-close" onclick="closeModal()">&times;</button>
        <button class="modal-nav prev" onclick="prevModalMedia()">‚ùÆ</button>
        <div class="modal-content">
            <img id="modalImage" class="modal-media" style="display: none;">
            <video id="modalVideo" class="modal-media" controls style="display: none;"></video>
        </div>
        <button class="modal-nav next" onclick="nextModalMedia()">‚ùØ</button>
        <div class="modal-counter" id="modalCounter"></div>
    </div>

    <script src="script.js"></script>
    <script>
// Check if authenticated (only for online version)
if (!window.location.hostname.includes('localhost') && 
    !window.location.hostname.includes('127.0.0.1')) {
    
    if (!localStorage.getItem('adminAuthenticated')) {
        window.location.href = 'admin-login.html';
    }
}
        // Admin dashboard functionality
        let adminCars = [];
        let adminUploadedMedia = [];
        
        async function loadDashboard() {
            try {
                const response = await fetch('/api/cars');
                adminCars = await response.json();
                updateStats();
                updateCarsTable();
            } catch (error) {
                console.error('Error loading dashboard:', error);
                showStatus('Error loading dashboard data', 'error');
            }
        }
        
        function updateStats() {
            // Total cars
            document.getElementById('totalCars').textContent = adminCars.length;
            
            // Active listings (all cars for now)
            document.getElementById('activeListings').textContent = adminCars.length;
            
            // Total images
            const totalImages = adminCars.reduce((sum, car) => 
                sum + (car.media ? car.media.length : 0), 0);
            document.getElementById('totalImages').textContent = totalImages;
            
            // Total inventory value
            const totalValue = adminCars.reduce((sum, car) => sum + (car.price || 0), 0);
            document.getElementById('totalValue').textContent = totalValue.toFixed(2);
        }
        
        function updateCarsTable() {
            const tbody = document.getElementById('adminCarsTable');
            
            if (adminCars.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="no-data">
                            <i class="fas fa-car"></i>
                            <p>No cars in inventory</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = adminCars.map(car => `
                <tr>
                    <td>
                        ${car.media && car.media.length > 0 ? 
                            `<img src="${car.media[0].url}" alt="${car.brand} ${car.model}" 
                                  onclick="openCarGallery('${car.id}')" class="table-image">` :
                            `<div class="no-table-image"><i class="fas fa-car"></i></div>`
                        }
                    </td>
                    <td>
                        <div class="car-details-cell">
                            <strong>${car.brand} ${car.model}</strong>
                            <div class="car-meta">
                                <span><i class="fas fa-calendar"></i> ${car.year}</span>
                                <span><i class="fas fa-tachometer-alt"></i> ${car.kilometrage.toLocaleString()} km</span>
                                <span><i class="fas fa-cog"></i> ${car.boite}</span>
                            </div>
                            ${car.version ? `<div class="car-version">${car.version}</div>` : ''}
                        </div>
                    </td>
                    <td class="price-cell">${car.price} M</td>
                    <td>
                        <span class="status-badge active">Active</span>
                    </td>
                    <td>
                        <div class="table-actions">
                            <button class="btn-table btn-edit" onclick="editAdminCar('${car.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-table btn-delete" onclick="deleteAdminCar('${car.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                            <button class="btn-table btn-view" onclick="openCarGallery('${car.id}')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
        
        function showAddForm() {
            document.getElementById('adminForm').style.display = 'block';
            document.getElementById('formTitle').textContent = 'Add New Car';
            document.getElementById('adminCarForm').reset();
            document.getElementById('adminMediaPreview').innerHTML = '';
            adminUploadedMedia = [];
            document.getElementById('adminSubmitBtn').innerHTML = '<i class="fas fa-plus"></i> Add Car';
        }
        
        function hideAdminForm() {
            document.getElementById('adminForm').style.display = 'none';
        }
        
        function handleAdminMediaUpload(event) {
            const files = event.target.files;
            const preview = document.getElementById('adminMediaPreview');
            
            for (let file of files) {
                if (file.size > 150 * 1024 * 1024) {
                    showStatus(`File ${file.name} is too large (max 150MB)`, 'error');
                    continue;
                }
                
                adminUploadedMedia.push(file);
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const previewItem = document.createElement('div');
                    previewItem.className = 'admin-preview-item';
                    
                    if (file.type.startsWith('image/')) {
                        previewItem.innerHTML = `
                            <img src="${e.target.result}" alt="${file.name}">
                            <button class="remove-admin-preview" onclick="removeAdminMedia('${file.name}')">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                    } else {
                        previewItem.innerHTML = `
                            <video src="${e.target.result}" alt="${file.name}"></video>
                            <button class="remove-admin-preview" onclick="removeAdminMedia('${file.name}')">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                    }
                    
                    preview.appendChild(previewItem);
                };
                reader.readAsDataURL(file);
            }
            
            event.target.value = '';
        }
        
        function removeAdminMedia(fileName) {
            adminUploadedMedia = adminUploadedMedia.filter(file => file.name !== fileName);
            const items = document.querySelectorAll('.admin-preview-item');
            items.forEach(item => {
                const media = item.querySelector('img, video');
                if (media && media.alt === fileName) {
                    item.remove();
                }
            });
        }
        
        async function editAdminCar(id) {
            try {
                const response = await fetch(`/api/cars/${id}`);
                const car = await response.json();
                
                if (car) {
                    document.getElementById('adminForm').style.display = 'block';
                    document.getElementById('formTitle').textContent = 'Edit Car';
                    document.getElementById('carId').value = car.id;
                    document.getElementById('adminBrand').value = car.brand;
                    document.getElementById('adminModel').value = car.model;
                    document.getElementById('adminYear').value = car.year;
                    document.getElementById('adminPrice').value = car.price;
                    document.getElementById('adminKilometrage').value = car.kilometrage;
                    document.getElementById('adminBoite').value = car.boite;
                    document.getElementById('adminVersion').value = car.version;
                    document.getElementById('adminDescription').value = car.description || '';
                    
                    document.getElementById('adminSubmitBtn').innerHTML = '<i class="fas fa-save"></i> Update Car';
                    
                    adminUploadedMedia = [];
                    document.getElementById('adminMediaPreview').innerHTML = '';
                    
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            } catch (error) {
                console.error('Error loading car for edit:', error);
                showStatus('Error loading car data', 'error');
            }
        }
        
        async function deleteAdminCar(id) {
            if (!confirm('Are you sure you want to delete this car? This action cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/cars/${id}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showStatus('Car deleted successfully', 'success');
                    loadDashboard();
                } else {
                    showStatus(result.error || 'Error deleting car', 'error');
                }
            } catch (error) {
                console.error('Error deleting car:', error);
                showStatus('Error deleting car', 'error');
            }
        }
        
        async function handleAdminSubmit(event) {
    event.preventDefault();
    event.stopPropagation();
    
    console.log('üì§ Admin form submission started');
    
    const carData = {
        brand: document.getElementById('adminBrand').value,
        model: document.getElementById('adminModel').value,
        year: parseInt(document.getElementById('adminYear').value),
        price: parseFloat(document.getElementById('adminPrice').value),
        kilometrage: parseInt(document.getElementById('adminKilometrage').value),
        boite: document.getElementById('adminBoite').value,
        version: document.getElementById('adminVersion').value,
        description: document.getElementById('adminDescription').value
    };
    
    console.log('Admin car data:', carData);
    console.log('Admin uploaded media count:', adminUploadedMedia.length);
    
    const formData = new FormData();
    
    // Add car data as JSON string
    formData.append('carData', JSON.stringify(carData));
    
    // Also add individual fields as backup
    for (const key in carData) {
        formData.append(key, carData[key]);
    }
    
    // Add media files
    if (adminUploadedMedia.length > 0) {
        console.log('Adding admin media files to FormData');
        adminUploadedMedia.forEach((file, index) => {
            console.log(`Admin File ${index + 1}:`, file.name, file.size, file.type);
            formData.append('media', file);
        });
    }
    
    const carId = document.getElementById('carId').value;
    const url = carId ? `/api/cars/${carId}` : '/api/cars';
    const method = carId ? 'PUT' : 'POST';
    
    console.log(`Sending to: ${url} with method: ${method}`);
    
    const submitBtn = document.getElementById('adminSubmitBtn');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    submitBtn.disabled = true;
    
    try {
        const response = await fetch(url, {
            method: method,
            body: formData
        });
        
        console.log('Admin response status:', response.status);
        
        const result = await response.json();
        console.log('Admin server response:', result);
        
        if (result.success) {
            showStatus(carId ? 'Car updated successfully!' : 'Car added successfully!', 'success');
            console.log('‚úÖ Admin operation successful');
            
            // Hide form and refresh dashboard
            hideAdminForm();
            loadDashboard();
            
            // Clear form data
            document.getElementById('adminCarForm').reset();
            document.getElementById('adminMediaPreview').innerHTML = '';
            adminUploadedMedia = [];
            document.getElementById('carId').value = '';
            
        } else {
            showStatus(result.error || 'Error saving car', 'error');
            console.error('‚ùå Admin server error:', result);
        }
    } catch (error) {
        console.error('‚ùå Admin network error:', error);
        showStatus('Network error. Please try again.', 'error');
    } finally {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    }
}
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                window.location.href = 'index.html';
            }
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboard();
            document.getElementById('adminCarForm').addEventListener('submit', handleAdminSubmit);
            
            // Mobile menu toggle
            const menuToggle = document.querySelector('.menu-toggle');
            const navLinks = document.querySelector('.nav-links');
            
            menuToggle.addEventListener('click', () => {
                navLinks.classList.toggle('active');
            });
        });
    </script>
</body>
</html>